/*
 * mnic_emif.c
 * 模块功能：EMIF模块对EMIFA进行了初始化，配置了EMIFA引脚复用功能和其连接的异步设备的时序
 *  Created on: 2015-12-7
 *      Author: SUN
 */
#include "hw_types.h"
#include "emifa.h"
#include "psc.h"
#include "soc_C6748.h"
#include "mnic_emif.h"
#include "mnic_C6748.h"
#include "hw_syscfg0_C6748.h"

#ifdef _DEBUG
#include "stdio.h"
#endif

static void EmifNorPinMuxSetup(void);


/*
 * 函数名：	 EMIFAInit(void)
 * 函数功能： EMIF初始化，配置EMIF引脚复用功能，配置异步设备时序
 */
void EMIFAInit(void)
{
	/*PSC模块配置：将PSC0中的EMIFA模块配置成PD0(ALWAYS ON)状态，下一状态为ENABLE*/
	PSCModuleControl(SOC_PSC_0_REGS, HW_PSC_EMIFA, PSC_POWERDOMAIN_ALWAYS_ON,
									     PSC_MDCTL_NEXT_ENABLE);
	/*EMIF引脚复用配置*/
	EmifNorPinMuxSetup();

    /*异步设备时序配置*/
	unsigned int waittime_config=0;

	/*
	 * EMCLK:456/4=114MHz
	 * 异步n配置寄存器(CEnCFG)字段说明
	 * 31:SS=0; 异步接口运行在普通模式,片选CS在整个异步设备访问期间有效
	 * 30:EW=0; 禁止扩展等待周期
	 * 29-26:   写建立时间-1：        W_SETUP  = 3h 4个EMCLK
	 * 25-20:   写脉冲时间-1：        W_STROBE = 6h 7个EMCLK
	 * 19-17:   写维持时间-1：        W_HOLD   = 3h 4个EMCLK
	 * 16-13:   读建立时间-1：        R_SETUP  = 3h 4个EMCLK
	 * 12-7:    读脉冲时间-1：        R_STROBE = 6h 7个EMCLK
	 * 6-4:     读维持时间-1：        R_HOLD   = 3h 4个EMCLK
	 * 3-2:     EMIFA 读写之间最少的EMIFA时钟的周期个数-1：    TA= 3h
	 * 1-0:     异步设备总线宽度： ASIZE    = 1h;选择16位总线宽度
	 */
	waittime_config=EMIFA_ASYNC_WAITTIME_CONFIG(3, 6, 3, 3, 6, 3, 3 );

    /*将waittime_config的值赋给异步2配置寄存器(CE2CFG)*/
	EMIFAWaitTimingConfig(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_2, waittime_config);
	/*异步设备2数据总线宽度为16bit*/
	EMIFAAsyncDevDataBusWidthSelect(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_2, EMIFA_DATA_BUSWITTH_16BIT);

	/*将waittime_config的值赋给异步3配置寄存器(CE3CFG)*/
	EMIFAWaitTimingConfig(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_3, waittime_config);
	/*异步设备3数据总线宽度为16bit*/
	EMIFAAsyncDevDataBusWidthSelect(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_3, EMIFA_DATA_BUSWITTH_16BIT);

	/*将waittime_config的值赋给异步4配置寄存器(CE4CFG)*/
	EMIFAWaitTimingConfig(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_4, waittime_config);
	/*异步设备4数据总线宽度为16bit*/
	EMIFAAsyncDevDataBusWidthSelect(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_4, EMIFA_DATA_BUSWITTH_16BIT);

	/*将waittime_config的值赋给异步5配置寄存器(CE5CFG)*/
	EMIFAWaitTimingConfig(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_5, waittime_config);
	/*异步设备5数据总线宽度为16bit*/
	EMIFAAsyncDevDataBusWidthSelect(SOC_EMIFA_0_REGS, EMIFA_CHIP_SELECT_5, EMIFA_DATA_BUSWITTH_16BIT);

#ifdef _DEBUG
	printf("EMIFA Configured for NOR.\n");
	printf("---------------------------------------------\n");
#endif
}

/*
 * 函数名：	 void EmifNorPinMux(void)
 * 函数功能：  配置引脚复用寄存器PINMUX5~PINMUX12中与EMIF相关的引脚复用
 */
static void EmifNorPinMuxSetup(void)
{
/*
//宏定义
//e.g.SYSCFG_PINMUX5_PINMUX5_31_28_EMA_BA0  寄存器PINMUX5的28-31位(0x00000001u)
//    SYSCFG_PINMUX5_PINMUX5_31_28_SHIFT    移位28位                            (0x0000001Cu)
*/

#define PINMUX5_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX5_PINMUX5_31_28_EMA_BA0 	<< SYSCFG_PINMUX5_PINMUX5_31_28_SHIFT) 	| \
										(SYSCFG_PINMUX5_PINMUX5_27_24_EMA_BA1 	<< SYSCFG_PINMUX5_PINMUX5_27_24_SHIFT)
#define PINMUX6_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX6_PINMUX6_27_24_EMA_WAIT1 << SYSCFG_PINMUX6_PINMUX6_27_24_SHIFT) 	| \
										(SYSCFG_PINMUX6_PINMUX6_3_0_EMA_CLK  	<< SYSCFG_PINMUX6_PINMUX6_3_0_SHIFT)
#define PINMUX7_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX7_PINMUX7_31_28_EMA_WAIT0	<< SYSCFG_PINMUX7_PINMUX7_31_28_SHIFT)	| \
										(SYSCFG_PINMUX7_PINMUX7_27_24_NEMA_RNW  << SYSCFG_PINMUX7_PINMUX7_27_24_SHIFT) 	| \
										(SYSCFG_PINMUX7_PINMUX7_23_20_NEMA_OE  	<< SYSCFG_PINMUX7_PINMUX7_23_20_SHIFT) 	| \
										(SYSCFG_PINMUX7_PINMUX7_19_16_NEMA_WE	<< SYSCFG_PINMUX7_PINMUX7_19_16_SHIFT) 	| \
										(SYSCFG_PINMUX7_PINMUX7_15_12_NEMA_CS5  << SYSCFG_PINMUX7_PINMUX7_15_12_SHIFT) 	| \
										(SYSCFG_PINMUX7_PINMUX7_11_8_NEMA_CS4	<< SYSCFG_PINMUX7_PINMUX7_11_8_SHIFT) 	| \
										(SYSCFG_PINMUX7_PINMUX7_7_4_NEMA_CS3	<< SYSCFG_PINMUX7_PINMUX7_7_4_SHIFT) 	| \
										(SYSCFG_PINMUX7_PINMUX7_3_0_NEMA_CS2	<< SYSCFG_PINMUX7_PINMUX7_3_0_SHIFT)
#define PINMUX8_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX8_PINMUX8_31_28_EMA_D8	<< SYSCFG_PINMUX8_PINMUX8_31_28_SHIFT)	| \
										(SYSCFG_PINMUX8_PINMUX8_27_24_EMA_D9	<< SYSCFG_PINMUX8_PINMUX8_27_24_SHIFT) 	| \
										(SYSCFG_PINMUX8_PINMUX8_23_20_EMA_D10  	<< SYSCFG_PINMUX8_PINMUX8_23_20_SHIFT) 	| \
										(SYSCFG_PINMUX8_PINMUX8_19_16_EMA_D11	<< SYSCFG_PINMUX8_PINMUX8_19_16_SHIFT) 	| \
										(SYSCFG_PINMUX8_PINMUX8_15_12_EMA_D12	<< SYSCFG_PINMUX8_PINMUX8_15_12_SHIFT) 	| \
										(SYSCFG_PINMUX8_PINMUX8_11_8_EMA_D13	<< SYSCFG_PINMUX8_PINMUX8_11_8_SHIFT) 	| \
										(SYSCFG_PINMUX8_PINMUX8_7_4_EMA_D14		<< SYSCFG_PINMUX8_PINMUX8_7_4_SHIFT) 	| \
										(SYSCFG_PINMUX8_PINMUX8_3_0_EMA_D15		<< SYSCFG_PINMUX8_PINMUX8_3_0_SHIFT)
#define PINMUX9_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX9_PINMUX9_31_28_EMA_D0	<< SYSCFG_PINMUX9_PINMUX9_31_28_SHIFT)	| \
										(SYSCFG_PINMUX9_PINMUX9_27_24_EMA_D1	<< SYSCFG_PINMUX9_PINMUX9_27_24_SHIFT) 	| \
										(SYSCFG_PINMUX9_PINMUX9_23_20_EMA_D2  	<< SYSCFG_PINMUX9_PINMUX9_23_20_SHIFT) 	| \
										(SYSCFG_PINMUX9_PINMUX9_19_16_EMA_D3	<< SYSCFG_PINMUX9_PINMUX9_19_16_SHIFT) 	| \
										(SYSCFG_PINMUX9_PINMUX9_15_12_EMA_D4	<< SYSCFG_PINMUX9_PINMUX9_15_12_SHIFT) 	| \
										(SYSCFG_PINMUX9_PINMUX9_11_8_EMA_D5		<< SYSCFG_PINMUX9_PINMUX9_11_8_SHIFT) 	| \
										(SYSCFG_PINMUX9_PINMUX9_7_4_EMA_D6		<< SYSCFG_PINMUX9_PINMUX9_7_4_SHIFT) 	| \
										(SYSCFG_PINMUX9_PINMUX9_3_0_EMA_D7		<< SYSCFG_PINMUX9_PINMUX9_3_0_SHIFT)
#define PINMUX10_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX10_PINMUX10_31_28_EMA_A16	<< SYSCFG_PINMUX10_PINMUX10_31_28_SHIFT)| \
										(SYSCFG_PINMUX10_PINMUX10_27_24_EMA_A17	<< SYSCFG_PINMUX10_PINMUX10_27_24_SHIFT)| \
										(SYSCFG_PINMUX10_PINMUX10_23_20_EMA_A18 << SYSCFG_PINMUX10_PINMUX10_23_20_SHIFT)| \
										(SYSCFG_PINMUX10_PINMUX10_19_16_EMA_A19	<< SYSCFG_PINMUX10_PINMUX10_19_16_SHIFT)| \
										(SYSCFG_PINMUX10_PINMUX10_15_12_EMA_A20	<< SYSCFG_PINMUX10_PINMUX10_15_12_SHIFT)| \
										(SYSCFG_PINMUX10_PINMUX10_11_8_EMA_A21	<< SYSCFG_PINMUX10_PINMUX10_11_8_SHIFT) | \
										(SYSCFG_PINMUX10_PINMUX10_7_4_EMA_A22	<< SYSCFG_PINMUX10_PINMUX10_7_4_SHIFT)
#define PINMUX11_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX11_PINMUX11_31_28_EMA_A8  << SYSCFG_PINMUX11_PINMUX11_31_28_SHIFT)| \
										(SYSCFG_PINMUX11_PINMUX11_27_24_EMA_A9  << SYSCFG_PINMUX11_PINMUX11_27_24_SHIFT)| \
										(SYSCFG_PINMUX11_PINMUX11_23_20_EMA_A10 << SYSCFG_PINMUX11_PINMUX11_23_20_SHIFT)| \
										(SYSCFG_PINMUX11_PINMUX11_19_16_EMA_A11 << SYSCFG_PINMUX11_PINMUX11_19_16_SHIFT)| \
										(SYSCFG_PINMUX11_PINMUX11_15_12_EMA_A12 << SYSCFG_PINMUX11_PINMUX11_15_12_SHIFT)| \
										(SYSCFG_PINMUX11_PINMUX11_11_8_EMA_A13	<< SYSCFG_PINMUX11_PINMUX11_11_8_SHIFT) | \
										(SYSCFG_PINMUX11_PINMUX11_7_4_EMA_A14	<< SYSCFG_PINMUX11_PINMUX11_7_4_SHIFT)  | \
										(SYSCFG_PINMUX11_PINMUX11_3_0_EMA_A15	<< SYSCFG_PINMUX11_PINMUX11_3_0_SHIFT)
#define PINMUX12_EMA_NOR_FUN_ENABLE		(SYSCFG_PINMUX12_PINMUX12_31_28_EMA_A0  << SYSCFG_PINMUX12_PINMUX12_31_28_SHIFT)| \
										(SYSCFG_PINMUX12_PINMUX12_27_24_EMA_A1  << SYSCFG_PINMUX12_PINMUX12_27_24_SHIFT)| \
										(SYSCFG_PINMUX12_PINMUX12_23_20_EMA_A2  << SYSCFG_PINMUX12_PINMUX12_23_20_SHIFT)| \
										(SYSCFG_PINMUX12_PINMUX12_19_16_EMA_A3  << SYSCFG_PINMUX12_PINMUX12_19_16_SHIFT)| \
										(SYSCFG_PINMUX12_PINMUX12_15_12_EMA_A4  << SYSCFG_PINMUX12_PINMUX12_15_12_SHIFT)| \
										(SYSCFG_PINMUX12_PINMUX12_11_8_EMA_A5	<< SYSCFG_PINMUX12_PINMUX12_11_8_SHIFT) | \
										(SYSCFG_PINMUX12_PINMUX12_7_4_EMA_A6	<< SYSCFG_PINMUX12_PINMUX12_7_4_SHIFT)  | \
										(SYSCFG_PINMUX12_PINMUX12_3_0_EMA_A7	<< SYSCFG_PINMUX12_PINMUX12_3_0_SHIFT)
    /*定义中间变量savePinmux*/
	unsigned int savePinmux = 0;

	/*HWREG:对硬件进行访问的专用宏，具体形式为HWREG(X)，对寄存器X进行赋值*/
	/*将PINMUX5的28~31位和24~27位清零*/
	savePinmux = (HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(5)) &
				~(SYSCFG_PINMUX5_PINMUX5_31_28) &
				~(SYSCFG_PINMUX5_PINMUX5_27_24));
	/*BA0 BA1*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(5)) = (PINMUX5_EMA_NOR_FUN_ENABLE | savePinmux);
    /*将PINMUX6的0~3位和24~27位清零*/
	savePinmux = (HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(6)) &
				~(SYSCFG_PINMUX6_PINMUX6_27_24) &
				~(SYSCFG_PINMUX6_PINMUX6_3_0));
	/*EM_WAIT[1] EM_CLK*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(6)) = (PINMUX6_EMA_NOR_FUN_ENABLE | savePinmux);

	savePinmux = (HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(7)) &
				~(SYSCFG_PINMUX7_PINMUX7_3_0));
	/*EM_WAIT[0] & EM_RW & EM_WE & EM_OE & EM_CS2*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(7)) = (PINMUX7_EMA_NOR_FUN_ENABLE | savePinmux);
	/*EM_CS3 & EM_CS4 & EM_CS5*/
	/*EM_D[8-15]*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(8)) = PINMUX8_EMA_NOR_FUN_ENABLE;
	/*EM_D[0-7]*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(9)) = PINMUX9_EMA_NOR_FUN_ENABLE;
	/*EM_A[16-22]*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(10)) = PINMUX10_EMA_NOR_FUN_ENABLE;
	/*EM_A[8-15]*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(11)) = PINMUX11_EMA_NOR_FUN_ENABLE;
	/*EM_A[0-7]*/
	HWREG(SOC_SYSCFG_0_REGS + SYSCFG0_PINMUX(12)) = PINMUX12_EMA_NOR_FUN_ENABLE;
}
/*****************************END OF FILE************************************/
